{% extends "base.html" %}

{% block content %}
<div class="cockpit-wrap">

  <div class="cockpit-topbar">
    <div class="cockpit-title">
      <h2>ğŸš€ AX Operations Cockpit</h2>
      <div class="cockpit-sub">
        <span class="pill">ğŸ“… Snapshot: <b>{{ snapshot['snapshot_date'] if snapshot else '-' }}</b></span>
        <span class="pill">ğŸ“Š Month: <b>{{ selected_month if selected_month else '-' }}</b></span>
        <span class="pill">ğŸ¯ Purpose: ì°¸ì—¬ ì´‰ì§„ & ìš´ì˜ ê´€ë¦¬ (ì„±ê³¼í‰ê°€ ëª©ì  ì•„ë‹˜)</span>
        {% if bias_strategy %}
        <span class="badge-warn">âš ï¸ í¸ì¤‘ ê²½ê³ : {{ bias_strategy }} {{ bias_ratio }}%</span>
        {% endif %}
      </div>
    </div>

    <div class="cockpit-actions">
      <form method="get" action="/" class="filters">
        <label>ìŠ¤ëƒ…ìƒ·</label>
        <select class="select" name="snapshot_id" onchange="this.form.submit()">
          {% for s in snapshots %}
          <option value="{{ s['snapshot_id'] }}" {% if snapshot and s['snapshot_id']==snapshot['snapshot_id']
            %}selected{% endif %}>{{ s['snapshot_date'] }}</option>
          {% endfor %}
        </select>

        <label>ì›”</label>
        <select class="select" name="month" onchange="this.form.submit()">
          {% for m in months %}
          <option value="{{ m }}" {% if selected_month==m %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>

        <label>ìƒíƒœ</label>
        <select class="select" name="filter_status" onchange="this.form.submit()">
          {% set statuses = ['ìŠ¹ì¸(ì§„í–‰ì¤‘)','ì œì•ˆ','ì‹¬ì˜ì¤‘','ì™„ë£Œ','ë³´ë¥˜'] %}
          {% for st in statuses %}
          <option value="{{ st }}" {% if selected_status==st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>

        <label>Champion</label>
        <select class="select" name="filter_champion" onchange="this.form.submit()">
          <option value="" {% if not selected_champion %}selected{% endif %}>ì „ì²´</option>
          {% if heatmap %}
          {% for champ_name in heatmap.keys() %}
          <option value="{{ champ_name }}" {% if selected_champion==champ_name %}selected{% endif %}>{{ champ_name }}
          </option>
          {% endfor %}
          {% endif %}
        </select>

        <label>ì „ëµ</label>
        <select class="select" name="filter_strategy" onchange="this.form.submit()">
          <option value="" {% if not selected_strategy %}selected{% endif %}>ì „ì²´</option>
          {% for sname in dist_labels %}
          <option value="{{ sname }}" {% if selected_strategy==sname %}selected{% endif %}>{{ sname }}</option>
          {% endfor %}
          <option value="(ë¯¸í• ë‹¹)" {% if selected_strategy=='(ë¯¸í• ë‹¹)' %}selected{% endif %}>(ë¯¸í• ë‹¹)</option>
        </select>
      </form>

      <a href="/admin">âš™ï¸ ìš´ì˜(ì—…ë¡œë“œ/ê´€ë¦¬)</a>
    </div>
  </div>

  {% if not months %}
  <div class="card">
    <div class="card-head">
      <p class="card-title">âš ï¸ ë°ì´í„° ì—†ìŒ</p>
    </div>
    <p class="card-meta">ì„ íƒí•œ ìŠ¤ëƒ…ìƒ·ì— ì›”ë³„ íƒ­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (AX_Masterë§Œ ìˆì„ ìˆ˜ ìˆìŒ)</p>
  </div>
  {% else %}

  <!-- =====================================================
       ROW 1: KEY METRICS - í•µì‹¬ ì§€í‘œ í•œëˆˆì— ë³´ê¸°
       ===================================================== -->
  <div class="cockpit-grid" style="grid-template-columns: repeat(5, 1fr);">
    <div class="kpi">
      <div class="label">ì§„í–‰ì¤‘(ëˆ„ì  ìŠ¹ì¸)</div>
      <div class="value">{{ kpis.cumulative_approved }}</div>
      <div class="hint">{{ selected_month }} ì´í•˜</div>
    </div>
    <div class="kpi">
      <div class="label">ì›” ì‹ ê·œ ì œì•ˆ</div>
      <div class="value">{{ kpis.month_proposals }}</div>
      <div class="hint">{{ selected_month }}</div>
    </div>
    <div class="kpi">
      <div class="label">ì›” ìŠ¹ì¸</div>
      <div class="value">{{ kpis.month_approvals }}</div>
      <div class="hint">{{ selected_month }}</div>
    </div>
    <div class="kpi">
      <div class="label">ê³¼ì œ ì¶”ì§„ í™•ëŒ€ìœ¨</div>
      <div class="value">{{ (kpis.expansion_rate * 100) | round(1) }}%</div>
      <div class="hint">vs {{ kpis.prev_month if kpis.prev_month else 'N/A' }}</div>
    </div>
    <div class="kpi">
      <div class="label">ì‹ ê·œ ê³¼ì œ ì œì•ˆ ìœ ì…ë¥ </div>
      <div class="value">{{ (kpis.proposal_inflow_rate * 100) | round(1) }}%</div>
      <div class="hint">ì œì•ˆ/ì›”ìŠ¹ì¸</div>
    </div>
  </div>

  <!-- =====================================================
       ROW 1-2: ACTIVE PROJECTS - ì§„í–‰ì¤‘ ê³¼ì œ ìƒì„¸ (ê°€ì¥ ì¤‘ìš”)
       ===================================================== -->
  <div class="card" style="margin-top:16px;">
    <div class="card-head">
      <div style="display:flex; align-items:center; gap:8px;">
        <p class="card-title">ğŸ”¥ ì§„í–‰ì¤‘ ê³¼ì œ ë¦¬ìŠ¤íŠ¸</p>
        <select
          style="background-color:rgba(15,30,55,0.6); color:rgba(255,255,255,0.9); border:1px solid rgba(96,165,250,0.3); border-radius:4px; padding:2px 6px; font-size:12px; outline:none;"
          onchange="location.href='/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}&filter_champion=' + this.value">
          <option value="">Champion ì „ì²´</option>
          {% if heatmap %}
          {% for champ_name in heatmap.keys() %}
          <option value="{{ champ_name }}" {% if selected_champion==champ_name %}selected{% endif %}>{{ champ_name }}
          </option>
          {% endfor %}
          {% endif %}
        </select>
      </div>
      <span class="card-meta">ìƒíƒœ: {{ selected_status }}</span>
    </div>

    <div class="split">
      <div>
        <div class="card-meta" style="margin-bottom: 10px; font-weight: 700;">Championë³„ ì§„í–‰ì¤‘ ìˆ˜ ë­í‚¹ (í´ë¦­í•˜ë©´ í•„í„° ì ìš©)</div>
        <table class="table-dark">
          <thead>
            <tr>
              <th style="width:50px;">#</th>
              <th>
                <a href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ selected_champion or '' }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}&sort={{ current_sort or '' }}&order={{ current_order or '' }}&rank_sort=champion&rank_order={% if current_rank_sort == 'champion' and current_rank_order == 'asc' %}desc{% else %}asc{% endif %}"
                  style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                  Champion
                  {% if current_rank_sort == 'champion' %}{{ 'â–¼' if current_rank_order == 'desc' else 'â–²' }}{% endif %}
                </a>
              </th>
              <th style="width:100px; text-align:right;">
                <a href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ selected_champion or '' }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}&sort={{ current_sort or '' }}&order={{ current_order or '' }}&rank_sort=count&rank_order={% if current_rank_sort == 'count' and current_rank_order == 'asc' %}desc{% else %}asc{% endif %}"
                  style="color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: flex-end; gap: 4px;">
                  Count
                  {% if current_rank_sort == 'count' %}{{ 'â–¼' if current_rank_order == 'desc' else 'â–²' }}{% endif %}
                </a>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for champ, cnt in active_ranking %}
            <tr>
              <td style="color:rgba(255,255,255,0.60);">{{ loop.index }}</td>
              <td>
                <a class="link"
                  href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ champ }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}">{{
                  champ }}</a>
              </td>
              <td style="text-align:right; font-weight:900;">{{ cnt }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div>
        <div class="card-meta" style="margin-bottom: 10px; font-weight: 700;">ë¦¬ìŠ¤íŠ¸ (í•„í„° ì ìš©ë¨ - {{ active_projects | length
          }}ê±´)</div>
        <div style="max-height: 450px; overflow-y: auto; padding-right: 8px;">
          <table class="table-dark">
            <thead style="position: sticky; top: 0; z-index: 10;">
              <tr>
                <th style="width:90px;">
                  <a href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ selected_champion or '' }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}&sort=project_id&order={% if current_sort == 'project_id' and current_order == 'asc' %}desc{% else %}asc{% endif %}"
                    style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    ê³¼ì œID
                    {% if current_sort == 'project_id' %}{{ 'â–¼' if current_order == 'desc' else 'â–²' }}{% endif %}
                  </a>
                </th>
                <th>
                  <a href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ selected_champion or '' }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}&sort=project_name&order={% if current_sort == 'project_name' and current_order == 'asc' %}desc{% else %}asc{% endif %}"
                    style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    ê³¼ì œëª…
                    {% if current_sort == 'project_name' %}{{ 'â–¼' if current_order == 'desc' else 'â–²' }}{% endif %}
                  </a>
                </th>
                <th style="width:120px;">
                  <a href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ selected_champion or '' }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}&sort=champion&order={% if current_sort == 'champion' and current_order == 'asc' %}desc{% else %}asc{% endif %}"
                    style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    Champion
                    {% if current_sort == 'champion' %}{{ 'â–¼' if current_order == 'desc' else 'â–²' }}{% endif %}
                  </a>
                </th>
                <th style="width:140px;">
                  <a href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ selected_champion or '' }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}&sort=strategy&order={% if current_sort == 'strategy' and current_order == 'asc' %}desc{% else %}asc{% endif %}"
                    style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    ì „ëµ
                    {% if current_sort == 'strategy' %}{{ 'â–¼' if current_order == 'desc' else 'â–²' }}{% endif %}
                  </a>
                </th>
                <th style="width:110px;">
                  <a href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ selected_champion or '' }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}&sort=status&order={% if current_sort == 'status' and current_order == 'asc' %}desc{% else %}asc{% endif %}"
                    style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    ìƒíƒœ
                    {% if current_sort == 'status' %}{{ 'â–¼' if current_order == 'desc' else 'â–²' }}{% endif %}
                  </a>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for p in active_projects %}
              <tr>
                <td style="color:rgba(96,165,250,0.90); font-weight:800;">{{ p['project_id'] }}</td>
                <td>{{ p['project_name'] }}</td>
                <td>{{ p['champion_name'] if p['champion_id'] else '(ë¯¸í• ë‹¹)' }}</td>
                <td>{{ p['strategy_name'] if p['strategy_id'] else '(ë¯¸í• ë‹¹)' }}</td>
                <td><span
                    style="padding: 4px 8px; background: rgba(52,211,153,0.20); border: 1px solid rgba(52,211,153,0.30); border-radius: 6px; font-size: 11px; font-weight: 700;">{{
                    p['current_status'] }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card-meta" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(96,165,250,0.12);">
      ğŸ’¡ <b>ì¤‘ìš”:</b> ë­í‚¹ì€ "ì„±ê³¼í‰ê°€"ê°€ ì•„ë‹ˆë¼ "AX ì°¸ì—¬ ì´‰ì§„ ë° ìš´ì˜ ê´€ë¦¬" ëª©ì ì…ë‹ˆë‹¤. í•„ìš” ì‹œ Champion ìµëª…í™”(ì˜µì…˜) ê°€ëŠ¥.
    </div>
  </div>

  <!-- =====================================================
       ROW 2: TRENDS & STATUS - íŠ¸ë Œë“œ ë° ìƒíƒœ ë¶„ì„
       ===================================================== -->
  <div class="cockpit-grid" style="margin-top:16px; grid-template-columns: 1.8fr 1fr 1.2fr;">

    <div class="card">
      <div class="card-head">
        <p class="card-title">ğŸ“ˆ ì›”ë³„ ì œì•ˆ/ìŠ¹ì¸ ì¶”ì´</p>
        <span class="card-meta">Snapshot ì „ì²´ ê¸°ê°„</span>
      </div>
      <canvas id="trendChart" height="160"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">ğŸ“‹ ì‹¬ì˜ìƒíƒœ ë¶„í¬</p>
        <span class="card-meta">ìŠ¤ëƒ…ìƒ· ê¸°ì¤€</span>
      </div>
      <canvas id="statusChart" height="160"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">ğŸ¯ ì „ëµë³„ ì§„í–‰ì¤‘</p>
        <span class="card-meta">Active Projects</span>
      </div>
      <canvas id="activeStrategyChart" height="160"></canvas>
    </div>

  </div>

  <!-- =====================================================
       ROW 3: TOP PERFORMERS - ìƒìœ„ Champion ë° ì „ëµ ë¶„ì„
       ===================================================== -->
  <div class="cockpit-grid" style="margin-top:16px; grid-template-columns: 1fr 1fr 1fr;">

    <div class="card">
      <div class="card-head">
        <p class="card-title">ğŸ† TOP 10 ì œì•ˆ Champion</p>
        <span class="card-meta">{{ selected_month }}</span>
      </div>
      <canvas id="topProposalChart" height="200"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">â­ TOP 10 ìŠ¹ì¸ Champion</p>
        <span class="card-meta">{{ selected_month }}</span>
      </div>
      <canvas id="topApprovalChart" height="200"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">ğŸ“Š ì „ëµë¶„ë¥˜ë³„ ë¶„í¬</p>
        <span class="card-meta">{{ selected_month }} + Active</span>
      </div>
      <canvas id="distChart" height="200"></canvas>
    </div>

  </div>

  <!-- =====================================================
       ROW 3-2: HEATMAP - Champion í™œë™ ì „ì²´ ë³´ê¸° (ì œì•ˆ/ìŠ¹ì¸)
       (ê¸°ì¡´ "ì›” ì‹ ê·œ ì œì•ˆ ì „ëµë¶„ë¥˜ ë¹„ì¤‘" ìë¦¬ì— ëŒ€ì²´)
       ===================================================== -->
  <div class="card" style="margin-top:16px;">
    <div class="card-head">
      <p class="card-title">ğŸ”¥ Champion í™œë™ íˆíŠ¸ë§µ (ì œì•ˆ/ìŠ¹ì¸)</p>
      <span class="card-meta">ìŠ¤ëƒ…ìƒ· ì „ì²´ ê¸°ê°„ - ë§ˆìš°ìŠ¤ ì˜¤ë²„ë¡œ ìƒì„¸ í™•ì¸</span>
    </div>

    <div class="heatmap-wrap">
      <table class="heatmap">
        <thead>
          <tr>
            <th style="min-width:160px;">Champion</th>
            {% for m in months %}
            <th>{{ m }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for champ_name, months_data in heatmap.items() %}
          <tr>
            <th style="white-space:nowrap; text-align:left;">{{ champ_name }}</th>

            {% for m in months %}
            {% set cell = months_data[m] %}
            {% set val = cell['proposals'] + cell['approvals'] %}
            {% set intensity = 0 %}
            {% if max_prop + max_app > 0 %}
            {% set intensity = (val) / (max_prop + max_app) %}
            {% endif %}

            {% set alpha = '%.2f' % (0.10 + (0.70 * intensity)) %}

            <td class="hm-cell {% if val == 0 %}hm-zero{% endif %}"
              title="ì œì•ˆ {{ cell['proposals'] }} / ìŠ¹ì¸ {{ cell['approvals'] }}" style="
                    background:
                      linear-gradient(180deg, rgba(15,30,55,0.78) 0%, rgba(15,30,55,0.46) 100%),
                      rgba(96,165,250,{{ alpha }});
                    border: 1px solid rgba(96,165,250,0.18);
                    {% if val > 0 %}box-shadow: 0 0 14px rgba(96,165,250,{{ '%.2f' % (intensity * 0.35) }});{% endif %}
                  ">
              <div style="font-weight:900; font-size:13px; color: rgba(255,255,255,0.95);">
                {{ cell['proposals'] }}/{{ cell['approvals'] }}
              </div>
              <div style="font-size:10px; color: rgba(255,255,255,0.70); margin-top:3px;">
                P/A
              </div>
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>



  <script>
    // Enhanced chart defaults for dark cockpit
    Chart.defaults.color = 'rgba(255,255,255,0.85)';
    Chart.defaults.borderColor = 'rgba(96,165,250,0.15)';
    Chart.defaults.font.family = "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial";
    Chart.defaults.font.size = 11;

    const trendMonths = {{ trend_months | tojson }};
    const trendProposals = {{ trend_proposals | tojson }};
    const trendApprovals = {{ trend_approvals | tojson }};

    const statusLabels = {{ status_labels | tojson }};
    const statusValues = {{ status_values | tojson }};

    const topPropLabels = {{ top_prop_labels | tojson }};
    const topPropValues = {{ top_prop_values | tojson }};
    const topAppLabels = {{ top_app_labels | tojson }};
    const topAppValues = {{ top_app_values | tojson }};

    const distLabels = {{ dist_labels | tojson }};
    const proposalsData = {{ proposals_data | tojson }};
    const approvalsData = {{ approvals_data | tojson }};
    const activeData = {{ active_data | tojson }};

    const activeStratLabels = {{ active_strat_labels | tojson }};
    const activeStratValues = {{ active_strat_values | tojson }};

    // 1) Trend line
    new Chart(document.getElementById('trendChart'), {
      type: 'line',
      data: {
        labels: trendMonths,
        datasets: [
          {
            label: 'ì œì•ˆ',
            data: trendProposals,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 4,
            pointHoverRadius: 6,
            borderColor: 'rgba(96,165,250,1)',
            backgroundColor: 'rgba(96,165,250,0.25)',
            fill: true,
            pointBackgroundColor: 'rgba(96,165,250,1)',
            pointBorderColor: 'rgba(255,255,255,0.3)',
            pointBorderWidth: 2
          },
          {
            label: 'ìŠ¹ì¸',
            data: trendApprovals,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 4,
            pointHoverRadius: 6,
            borderColor: 'rgba(167,139,250,1)',
            backgroundColor: 'rgba(167,139,250,0.22)',
            fill: true,
            pointBackgroundColor: 'rgba(167,139,250,1)',
            pointBorderColor: 'rgba(255,255,255,0.3)',
            pointBorderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: { position: 'top', labels: { boxWidth: 12, padding: 15, font: { weight: 'bold' } } },
          tooltip: {
            backgroundColor: 'rgba(15,30,55,0.95)',
            borderColor: 'rgba(96,165,250,0.5)',
            borderWidth: 1,
            padding: 12,
            titleFont: { size: 13, weight: 'bold' },
            bodyFont: { size: 12 }
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: 'rgba(96,165,250,0.08)' } },
          x: { grid: { display: false } }
        }
      }
    });

    // 2) Status donut
    new Chart(document.getElementById('statusChart'), {
      type: 'doughnut',
      data: {
        labels: statusLabels,
        datasets: [{
          data: statusValues,
          backgroundColor: [
            'rgba(96,165,250,0.90)',
            'rgba(52,211,153,0.85)',
            'rgba(251,191,36,0.83)',
            'rgba(167,139,250,0.85)',
            'rgba(239,68,68,0.83)',
            'rgba(148,163,184,0.60)'
          ],
          borderWidth: 2,
          borderColor: 'rgba(15,30,55,0.8)',
          hoverOffset: 8
        }]
      },
      options: {
        responsive: true,
        cutout: '65%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: 'rgba(255,255,255,0.88)',
              padding: 12,
              font: { size: 11, weight: 'bold' },
              generateLabels: function (chart) {
                const data = chart.data;
                return data.labels.map((label, i) => ({
                  text: `${label} (${data.datasets[0].data[i]})`,
                  fillStyle: data.datasets[0].backgroundColor[i],
                  strokeStyle: 'transparent',
                  fontColor: 'rgba(255,255,255,0.85)', // Match Chart.defaults.color
                  hidden: false,
                  index: i
                }));
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(15,30,55,0.95)',
            borderColor: 'rgba(96,165,250,0.5)',
            borderWidth: 1,
            padding: 12
          }
        }
      }
    });

    // 3) Top 10 Proposal - Horizontal bar
    new Chart(document.getElementById('topProposalChart'), {
      type: 'bar',
      data: {
        labels: topPropLabels,
        datasets: [{
          label: 'ì œì•ˆ ê±´ìˆ˜',
          data: topPropValues,
          backgroundColor: 'rgba(96,165,250,0.70)',
          borderColor: 'rgba(96,165,250,0.9)',
          borderWidth: 1,
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15,30,55,0.95)',
            borderColor: 'rgba(96,165,250,0.5)',
            borderWidth: 1,
            padding: 10
          }
        },
        scales: {
          x: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: 'rgba(96,165,250,0.08)' } },
          y: { grid: { display: false } }
        }
      }
    });

    // 4) Top 10 Approval - Horizontal bar
    new Chart(document.getElementById('topApprovalChart'), {
      type: 'bar',
      data: {
        labels: topAppLabels,
        datasets: [{
          label: 'ìŠ¹ì¸ ê±´ìˆ˜',
          data: topAppValues,
          backgroundColor: 'rgba(167,139,250,0.70)',
          borderColor: 'rgba(167,139,250,0.9)',
          borderWidth: 1,
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15,30,55,0.95)',
            borderColor: 'rgba(167,139,250,0.5)',
            borderWidth: 1,
            padding: 10
          }
        },
        scales: {
          x: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: 'rgba(96,165,250,0.08)' } },
          y: { grid: { display: false } }
        }
      }
    });

    // 5) Strategy distribution (clustered)
    new Chart(document.getElementById('distChart'), {
      type: 'bar',
      data: {
        labels: distLabels,
        datasets: [
          {
            label: 'ì œì•ˆ',
            data: proposalsData,
            backgroundColor: 'rgba(96,165,250,0.60)',
            borderColor: 'rgba(96,165,250,0.9)',
            borderWidth: 1,
            borderRadius: 4
          },
          {
            label: 'ìŠ¹ì¸',
            data: approvalsData,
            backgroundColor: 'rgba(167,139,250,0.60)',
            borderColor: 'rgba(167,139,250,0.9)',
            borderWidth: 1,
            borderRadius: 4
          },
          {
            label: 'ì§„í–‰ì¤‘',
            data: activeData,
            backgroundColor: 'rgba(52,211,153,0.60)',
            borderColor: 'rgba(52,211,153,0.9)',
            borderWidth: 1,
            borderRadius: 4
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top', labels: { boxWidth: 12, padding: 12, font: { weight: 'bold' } } },
          tooltip: {
            backgroundColor: 'rgba(15,30,55,0.95)',
            borderColor: 'rgba(96,165,250,0.5)',
            borderWidth: 1,
            padding: 10
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: 'rgba(96,165,250,0.08)' } },
          x: { grid: { display: false } }
        }
      }
    });

    // 6) Active by strategy (doughnut)
    new Chart(document.getElementById('activeStrategyChart'), {
      type: 'doughnut',
      data: {
        labels: activeStratLabels,
        datasets: [{
          label: 'ì§„í–‰ì¤‘',
          data: activeStratValues,
          backgroundColor: [
            'rgba(52,211,153,0.85)',
            'rgba(96,165,250,0.85)',
            'rgba(167,139,250,0.85)',
            'rgba(251,191,36,0.80)',
            'rgba(239,68,68,0.80)',
            'rgba(148,163,184,0.70)'
          ],
          borderWidth: 2,
          borderColor: 'rgba(15,30,55,0.8)',
          hoverOffset: 6
        }]
      },
      options: {
        responsive: true,
        cutout: '60%',
        plugins: {
          legend: { position: 'bottom', labels: { padding: 10, font: { size: 11, weight: 'bold' } } },
          tooltip: {
            backgroundColor: 'rgba(15,30,55,0.95)',
            borderColor: 'rgba(52,211,153,0.5)',
            borderWidth: 1,
            padding: 10
          }
        }
      }
    });

  </script>

  {% endif %}

</div>
{% endblock %}